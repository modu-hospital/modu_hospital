<head>
    <!-- ë³‘ì›ìƒì„¸í˜ì´ì§€ ìŠ¬ë¼ì´ë“œë¥¼ ìœ„í•œ ì¶”ê°€ -->
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"
    ></script>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous"
    />
</head>

<style>
    /* .hospital_all {
        box-sizing: border-box;
    }

    .container_hos {
        width: 600px;
        
    }

    .inner_hos {
        width: 100%;
        display: flex;
        
        align-items: flex-start;
        margin: 30px 0;
    } */

    /* #index_01 {
        width: 1000px;
        height: 400px;
        border: 1px solid dimgrey;
        margin: 0 auto;
    }

    #slide1 {
        height: 100%;
        overflow: hidden;
        border-bottom: 1px solid dimgrey;
    }

    #slide1>ul {
        width: 3600px;
        font-size: 0;
    }

    #slide1>ul>li {
        display: block;
        font-size: 0;
        width: 100%;
        height: auto;

    } */

    #content-image {
        padding: 30px;
        text-align: center;
    }

    #bigimages {
        margin-bottom: 10px;
    }

    #bigimage {
        width: 500px;
        height: 500px;
    }

    .small {
        width: 100px;
        height: 100px;
    }
</style>

<div id="content-image"></div>

<div id="main">
    <div class="inner" style="padding: 0">
        <div class="hospital_all">
            <!--ìƒìœ„ div 3ê°œëŠ” ê³µí†µ <div id="index_01">
                <div id="slide1">
                    <ul id="hospital-image"></ul>
                </div>
            </div> -->

            <!-- <div class="container_hos">
                <div class="inner_hos" id="hospital-image">
                    ì´ë¯¸ì§€
                </div>
            </div>
            <button class="prev_bt" type="button">prev</button>
            <button class="next_bt" type="button">next</button> -->

            <div>
                <table id="hospitalName">
                    <tr>
                        <th>ë³‘ì›ì´ë¦„</th>
                        <th>ì£¼ì†Œ</th>
                        <th>ì „í™”ë²ˆí˜¸</th>
                    </tr>
                </table>
            </div>

            <div>
                <table id="departmentList">
                    <tr>
                        <th>ì§„ë£Œê³¼</th>
                    </tr>
                </table>
            </div>

            <div>
                <table id="doctorsList">
                    <tr>
                        <th>ì˜ì‚¬ì´ë¦„</th>
                        <th>ì˜ì‚¬ì‚¬ì§„</th>
                        <th>ì˜ì‚¬ì†Œê°œ</th>
                        <th>ì§„ë£Œê³¼</th>
                        <th>ê·¼ë¬´ë‚ </th>
                    </tr>
                </table>
            </div>
            <div class="review">
                <table id="reviewList">
                    <tr>
                        <th>#</th>
                        <th>ì‘ì„±ì</th>
                        <th>ë‚´ìš©</th>
                        <th>í‰ì </th>
                        <th>ì‘ì„±ë‚ ì§œ</th>
                    </tr>
                </table>
            </div>
            <div>
                <button onclick="goToReservation()">ì˜ˆì•½í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>


    $(document).ready(function () {
        getReview();
        getdoctor();
        getdepartment();
        gethospitalimage();
        hospitalName();
    });

    const id = window.location.pathname.split('/')[2];

    //ë³‘ì› ì´ë¯¸ì§€
    function gethospitalimage() {
        $.ajax({
            type: 'GET',
            url: `/api/hospitals/detail/${id}?time=${Date.now()}`,
            dataType: 'json',
            success: function (response) {
                const hospitalData = response;

                let temp_html = `
                <div id="bigimages">
                    <img id="bigimage"
                    src="${hospitalData.oneHospital.hospitalImage[0].url}">
                </div>
                <div id="smallimages">
                    ${hospitalData.oneHospital.hospitalImage
                        .map((image) => `<img class='small' src="${image.url}">`)
                        .join('')}
                </div>
                `;

                $('#content-image').append(temp_html);

                var bigPic = document.querySelector('#bigimage');
                var smallPics = document.querySelectorAll('.small');

                for (var i = 0; i < smallPics.length; i++) {
                    smallPics[i].addEventListener('click', changepic);
                }

                function changepic() {
                    var smallPicAttribute = this.getAttribute('src');
                    bigPic.setAttribute('src', smallPicAttribute);
                }

                // for (let i = 0; i < hospitalData.oneHospital.hospitalImage.length; i++) {
                //     let hospitalimage = hospitalData.oneHospital.hospitalImage[i].url;
                //     console.log(hospitalimage)

                //     let temp_html = `<img class="s-img" src="${hospitalimage}">`;

                //     $('#hospital-image').append(temp_html);
                // }
            },
            error: function (error) {
                console.log(error.responseJSON);
            },
        });
    }

    //ë³‘ì› ì •ë³´
    function hospitalName() {
        $.ajax({
            type: 'GET',
            url: `/api/hospitals/detail/${id}`,
            dataType: 'json',
            success: function (response) {
                const hospitalData = response;

                let hospitalName = hospitalData.oneHospital.hospitalName;
                let hospitalAddress = hospitalData.oneHospital.hospitalAddress;
                let hospitalphone = hospitalData.oneHospital.hospitalphone;

                let temp_html = `
                        <tr>
                            <td>${hospitalName}</td>
                            <td>${hospitalAddress}</td>
                            <td>${hospitalphone}</td>
                        </tr>
                    `;

                $('#hospitalName').append(temp_html);
            },
            error: function (error) {
                console.log(error.responseJSON);
            },
        });
    }

    //ì˜ì‚¬ë“¤ ì§„ë£Œê³¼ëª©
    function getdepartment() {
        $.ajax({
            type: 'GET',
            url: `/api/hospitals/detail/${id}`,
            dataType: 'json',
            success: function (response) {
                const hospitalData = response;

                let hospitalDepartmentList = [];

                for (let i = 0; i < hospitalData.oneHospital.doctors.length; i++) {
                    let department = hospitalData.oneHospital.doctors[i].department.split(',');

                    for (let j = 0; j < department.length; j++) {
                        hospitalDepartmentList.push(department[j]);
                    }
                }

                hospitalDepartmentList = Array.from(new Set(hospitalDepartmentList));

                let temp_html = `
                    <tr>
                        <td>${hospitalDepartmentList}</td>
                    </tr>
                `;

                $('#departmentList').append(temp_html);
            },
            error: function (error) {
                console.log(error.responseJSON);
            },
        });
    }

    //ì˜ì‚¬ ì´ë¯¸ì§€ ë° ì •ë³´
    function getdoctor() {
        $.ajax({
            type: 'GET',
            url: `/api/hospitals/detail/${id}`,
            dataType: 'json',
            success: function (response) {
                const hospitalData = response;

                for (let i = 0; i < hospitalData.oneHospital.doctors.length; i++) {
                    let doctors = hospitalData.oneHospital.doctors[i].doctors;
                    let doctorImage = hospitalData.oneHospital.doctors[i].doctorImage;
                    let doctorContent = hospitalData.oneHospital.doctors[i].doctorContent;
                    let department = hospitalData.oneHospital.doctors[i].department;

                    let workTime = hospitalData.oneHospital.doctors[i].workTime;
                    let workTimeSum = '';

                    let temp_html = `<tbody>
                            <tr>
                            <td>${doctors}</td>
                            <th><img src="${doctorImage}" style="width: 100px" alt="ì˜ì‚¬ì‚¬ì§„"></th>
                            <td>${doctorContent}</td>
                            <td>${department}</td>
                            <td id="${doctors}" style="vertical-align: top;"></td>
                            </tr>
                        </tbody>`;

                    $('#doctorsList').append(temp_html);

                    for (let j = 0; j < workTime.length; j++) {
                        let day = workTime[j].day;
                        let start = workTime[j].start;
                        let end = workTime[j].end;

                        switch (day) {
                            case 1:
                                day = 'ì›”';
                                break;
                            case 2:
                                day = 'í™”';
                                break;
                            case 3:
                                day = 'ìˆ˜';
                                break;
                            case 4:
                                day = 'ëª©';
                                break;
                            case 5:
                                day = 'ê¸ˆ';
                                break;
                            case 6:
                                day = 'í† ';
                                break;
                            default:
                                day = 'ì¼';
                                break;
                        }

                        let start_minutes = start.substr(0, 5);
                        let end_minutes = end.substr(0, 5);

                        workTimeSum = `${day} ${start_minutes}~${end_minutes}`;

                        document.getElementById(
                            `${doctors}`
                        ).innerHTML += `<div>${workTimeSum}<div>`;
                    }
                }
            },
            error: function (error) {
                console.log(error.responseJSON);
            },
            // í† í° ì¬ë°œê¸‰ api í•¨ìˆ˜
            // error: function (error) {
            //     if (error.message === 'accessToken ë§Œë£Œ') {
            //         whenExpiredToken();
            //     } else {
            //         console.log(error);
            //     }
            // },
        });
    }

    //ë¦¬ë·°ì¡°íšŒ
    function getReview() {
        $.ajax({
            type: 'GET',
            url: `/api/hospitals/detail/${id}`,
            dataType: 'json',
            success: function (response) {
                const hospitalData = response;

                for (let i = 0; i < hospitalData.oneHospital.reviews.length; i++) {
                    let contents = hospitalData.oneHospital.reviews[i].contents;
                    let star = hospitalData.oneHospital.reviews[i].star;
                    let createdAt = hospitalData.oneHospital.reviews[i].createdAt;

                    const dateData = new Date(createdAt);
                    const year = dateData.getFullYear();
                    const month = dateData.getMonth() + 1;
                    const date = dateData.getDate();

                    let temp_html = `<tbody>
                            <tr>
                                <th scope="row">${i + 1}</th>
                                <td>${name}</td>
                                <td>${contents}</td>
                                <td>${star}</td>
                                <td>${year}ë…„ ${month}ì›” ${date}ì¼</td>
                            </tr>
                        </tbody>`;

                    $('#reviewList').append(temp_html);
                }
            },
            error: function (error) {
                console.log(error.responseJSON);
            },
        });
    }

    // $.ajax({
    //     url: ``,
    //     type: 'get',
    //     headers: {
    //         'X-Refresh-Token': refreshToken
    //         // 'Authentication': document.cookie(res.accessToken)
    //     },
    //     success: function(response) {
    //         const newAccessToken = response.access_token;

    //     },
    //     error: function(error) {
    //         $.ajax({
    //             url:`/api/token/${userId}`,
    //             headers: {
    //                 'Authorization': 'Bearer ' + newAccessToken
    //             },
    //             success: function(response) {
    //                 const newAccessToken = response.access_token;
    //             }
    //         });
    //         console.log(error);
    //     }
    // });

    function goToReservation() {
        if (document.cookie !== '') {
            const id = window.location.pathname.split('/')[2];
            location.href = `/users/reservation/${id}`;
        } else if (document.cookie === '') {
            swal({
                title: 'ğŸ˜“ ì£„ì†¡í•©ë‹ˆë‹¤.',
                text: 'ëª¨ë‘ì˜ ë³‘ì› íšŒì›ë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”??',
                icon: 'warning',
                buttons: true,
                dangerMode: true,
            }).then((willDelete) => {
                if (willDelete) {
                    swal('ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', '', 'success').then((value) => {
                        window.location.href = '/login';
                    });
                } else {
                    swal('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
    }
</script>
